---
import '@/styles/global.css'
import type { TagsLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig } from '@/config'
import { render } from 'astro:content'

const { posts, slug } = Astro.props as TagsLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
---

<BaseLayout
  title={`${slug.toUpperCase()} · ${themeConfig.site.title}`}
  description={themeConfig.site.description}
  type="post"
>
  <BaseHead
    title={`${slug.toUpperCase()} · ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {
          posts.map(async (post) => {
            const { remarkPluginFrontmatter } = await render(post)

            return (
              <div class="title">
                <a href={`/${post.id}`}>{post.data.title}</a>
                <div class="info-article">
                  <div class="date">
                    <FormattedDate date={post.data.pubDate} context="post" />
                    {themeConfig.post.readingTime && remarkPluginFrontmatter.readingTime && (
                      <span class="reading-time">
                        <span class="separator">·</span>
                        {remarkPluginFrontmatter.readingTime.text}
                      </span>
                    )}
                  </div>
                  <div class="tags">
                    {post.data.tags?.map((tag) => (
                      <span class="tag">{tag}</span>
                    ))}
                  </div>
                </div>
              </div>
              <br />
            )
          })
        }
      </div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }

  .prose .title a {
    margin-bottom: 1rem !important;
  }
</style>
